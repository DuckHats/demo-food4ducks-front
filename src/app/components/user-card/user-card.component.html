<div
  *ngIf="loading"
  class="min-h-screen bg-slate-50 p-8 flex items-center justify-center"
>
  <div class="w-full max-w-5xl space-y-4">
    <div class="flex items-center justify-center h-96">
      <app-loader></app-loader>
    </div>
  </div>
</div>

<div
  *ngIf="!loading && student"
  class="min-h-screen bg-slate-50 flex flex-col md:flex-row font-sans selection:bg-primary/10"
>
  <!-- Mobile Header -->
  <header
    class="md:hidden bg-white border-b border-slate-200 p-4 flex items-center justify-between sticky top-0 z-30"
  >
    <div class="flex items-center gap-3">
      <button
        (click)="toggleMobileMenu()"
        class="p-2 -ml-2 text-slate-600 hover:bg-slate-50 rounded-xl transition-colors"
      >
        <mat-icon>menu</mat-icon>
      </button>
      <span class="font-bold text-slate-800 text-lg">{{
        UILabels.PROFILE.TITLE
      }}</span>
    </div>
  </header>

  <!-- Mobile Backdrop -->
  <div
    *ngIf="isMobileMenuOpen"
    (click)="toggleMobileMenu()"
    class="fixed inset-0 bg-black/20 z-[190] md:hidden backdrop-blur-sm transition-opacity"
    @overlayFade
  ></div>

  <!-- Sidebar -->
  <aside
    class="fixed md:sticky top-0 bottom-0 left-0 bg-white/80 backdrop-blur-xl border-r border-slate-100 flex flex-col shadow-[20px_0_50px_rgba(0,0,0,0.02)] z-[200] md:z-[50] transition-all duration-500 group/sidebar h-screen"
    [ngClass]="{
      'translate-x-0': isMobileMenuOpen,
      '-translate-x-full md:translate-x-0': !isMobileMenuOpen,
      'w-72 md:w-80': !isSidebarCollapsed,
      'w-72 md:w-24': isSidebarCollapsed,
      'shadow-2xl md:shadow-[20px_0_50px_rgba(0,0,0,0.02)]': isMobileMenuOpen,
    }"
  >
    <!-- Collapse Toggle (Desktop) -->
    <button
      (click)="toggleSidebar()"
      class="hidden md:flex absolute -right-4 top-12 w-8 h-8 bg-white border border-slate-100 rounded-full items-center justify-center text-slate-400 hover:text-primary hover:border-primary shadow-xl z-50 transition-all opacity-0 group-hover/sidebar:opacity-100 hover:scale-110 active:scale-95"
      [ngClass]="{ 'rotate-180': isSidebarCollapsed }"
    >
      <mat-icon class="text-lg">chevron_left</mat-icon>
    </button>

    <!-- Sidebar Header -->
    <div
      class="p-6 sm:p-8 flex items-center justify-between overflow-hidden transition-all duration-500 flex-shrink-0"
    >
      <div
        class="flex items-center"
        [ngClass]="
          isSidebarCollapsed
            ? 'md:justify-center w-full'
            : 'gap-4 justify-start'
        "
      >
        <div class="relative group/avatar">
          <div
            class="rounded-2xl bg-gradient-to-br from-primary to-primary-dark text-white flex-shrink-0 flex items-center justify-center shadow-lg shadow-primary/20 transition-all duration-500 group-hover/sidebar:rotate-3 overflow-hidden"
            [ngClass]="
              isSidebarCollapsed ? 'md:w-12 md:h-12 w-14 h-14' : 'w-14 h-14'
            "
          >
            <img
              *ngIf="student.avatar; else defaultSidebarIcon"
              [src]="student.avatar"
              referrerpolicy="no-referrer"
              alt="Sidebar User Avatar"
              class="w-full h-full object-cover"
            />
            <ng-template #defaultSidebarIcon>
              <mat-icon
                class="transition-transform duration-500 group-hover/avatar:scale-110"
                [ngClass]="isSidebarCollapsed ? 'scale-90' : 'scale-110'"
                >person</mat-icon
              >
            </ng-template>
          </div>
          <div
            *ngIf="!isSidebarCollapsed"
            class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white rounded-full hidden md:block"
          ></div>
        </div>
        <div
          class="overflow-hidden transition-all duration-500"
          [ngClass]="
            isSidebarCollapsed
              ? 'md:opacity-0 md:w-0 md:ml-0 opacity-100 w-auto ml-2'
              : 'opacity-100 w-auto ml-2'
          "
        >
          <p
            class="font-black text-slate-800 truncate leading-tight tracking-tight"
          >
            {{ student.name }}
          </p>
          <p
            class="text-[10px] text-slate-400 truncate mt-1 font-black uppercase tracking-widest"
          >
            {{
              student.user_type_id === 1
                ? UILabels.PROFILE.ROLES.ADMIN
                : UILabels.PROFILE.ROLES.USER
            }}
          </p>
        </div>
      </div>
      <!-- Close Mobile Menu Button -->
      <button
        (click)="toggleMobileMenu()"
        class="md:hidden p-3 bg-slate-50 rounded-xl text-slate-400 hover:text-primary transition-all active:scale-90"
      >
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Navigation -->
    <nav
      class="flex-1 px-4 py-2 flex flex-col gap-3 mt-4 overflow-y-auto scrollbar-none"
    >
      <button
        (click)="setActiveTab('profile')"
        [class.active]="activeTab === 'profile'"
        class="nav-item relative flex items-center rounded-2xl text-[14px] font-black text-slate-400 transition-all duration-300 hover:bg-slate-50 hover:text-slate-600 group [&.active]:bg-primary/10 [&.active]:text-primary overflow-hidden h-14 flex-shrink-0 w-full"
        [ngClass]="
          isSidebarCollapsed
            ? 'justify-start md:justify-center px-4 md:px-0'
            : 'px-5 gap-4'
        "
      >
        <mat-icon
          [ngClass]="
            activeTab === 'profile' ? 'text-primary' : 'text-slate-300'
          "
          class="transition-all duration-300 group-hover:scale-110 flex-shrink-0"
          [ngClass]="{ 'mr-3 md:mr-0': isSidebarCollapsed }"
          >account_circle</mat-icon
        >
        <span
          class="transition-all duration-300 whitespace-nowrap uppercase tracking-widest text-[11px]"
          [ngClass]="
            isSidebarCollapsed
              ? 'md:opacity-0 md:w-0 opacity-100 w-auto'
              : 'opacity-100 w-auto'
          "
          >{{ UILabels.PROFILE.TABS.PROFILE }}</span
        >
      </button>

      <button
        *ngIf="student.user_type_id == 2"
        (click)="setActiveTab('allergies')"
        [class.active]="activeTab === 'allergies'"
        class="nav-item relative flex items-center rounded-2xl text-[14px] font-black text-slate-400 transition-all duration-300 hover:bg-slate-50 hover:text-slate-600 group [&.active]:bg-primary/10 [&.active]:text-primary overflow-hidden h-14 flex-shrink-0 w-full"
        [ngClass]="
          isSidebarCollapsed
            ? 'justify-start md:justify-center px-4 md:px-0'
            : 'px-5 gap-4'
        "
      >
        <mat-icon
          [ngClass]="
            activeTab === 'allergies' ? 'text-primary' : 'text-slate-300'
          "
          class="transition-all duration-300 group-hover:scale-110 flex-shrink-0"
          [ngClass]="{ 'mr-3 md:mr-0': isSidebarCollapsed }"
          >report_problem</mat-icon
        >
        <span
          class="transition-all duration-300 whitespace-nowrap uppercase tracking-widest text-[11px]"
          [ngClass]="
            isSidebarCollapsed
              ? 'md:opacity-0 md:w-0 opacity-100 w-auto'
              : 'opacity-100 w-auto'
          "
          >{{ UILabels.PROFILE.TABS.ALLERGIES }}</span
        >
      </button>

      <button
        *ngIf="student.user_type_id == 1"
        (click)="setActiveTab('config')"
        [class.active]="activeTab === 'config'"
        class="nav-item relative flex items-center rounded-2xl text-[14px] font-black text-slate-400 transition-all duration-300 hover:bg-slate-50 hover:text-slate-600 group [&.active]:bg-primary/10 [&.active]:text-primary overflow-hidden h-14 flex-shrink-0 w-full"
        [ngClass]="
          isSidebarCollapsed
            ? 'justify-start md:justify-center px-4 md:px-0'
            : 'px-5 gap-4'
        "
      >
        <mat-icon
          [ngClass]="activeTab === 'config' ? 'text-primary' : 'text-slate-300'"
          class="transition-all duration-300 group-hover:scale-110 flex-shrink-0"
          [ngClass]="{ 'mr-3 md:mr-0': isSidebarCollapsed }"
          >settings</mat-icon
        >
        <span
          class="transition-all duration-300 whitespace-nowrap uppercase tracking-widest text-[11px]"
          [ngClass]="
            isSidebarCollapsed
              ? 'md:opacity-0 md:w-0 opacity-100 w-auto'
              : 'opacity-100 w-auto'
          "
          >{{ UILabels.PROFILE.TABS.CONFIG }}</span
        >
      </button>

      <!-- Transactions -->
      <button
        *ngIf="student.user_type_id === 2"
        (click)="setActiveTab('transactions')"
        [class.active]="activeTab === 'transactions'"
        class="nav-item relative flex items-center rounded-2xl text-[14px] font-black text-slate-400 transition-all duration-300 hover:bg-slate-50 hover:text-slate-600 group [&.active]:bg-emerald-50 [&.active]:text-emerald-600 overflow-hidden h-14 flex-shrink-0 w-full"
        [ngClass]="
          isSidebarCollapsed
            ? 'justify-start md:justify-center px-4 md:px-0'
            : 'px-5 gap-4'
        "
      >
        <mat-icon
          [ngClass]="
            activeTab === 'transactions' ? 'text-emerald-500' : 'text-slate-300'
          "
          class="transition-all duration-300 group-hover:scale-110 flex-shrink-0"
          [ngClass]="{ 'mr-3 md:mr-0': isSidebarCollapsed }"
          >receipt_long</mat-icon
        >
        <span
          class="transition-all duration-300 whitespace-nowrap uppercase tracking-widest text-[11px]"
          [ngClass]="
            isSidebarCollapsed
              ? 'md:opacity-0 md:w-0 opacity-100 w-auto'
              : 'opacity-100 w-auto'
          "
          >{{ UILabels.PROFILE.TABS.TRANSACTIONS }}</span
        >
      </button>
    </nav>

    <!-- Sidebar Footer -->
    <div class="p-6 border-t border-slate-50 bg-slate-50/20">
      <button
        (click)="logout()"
        class="relative flex items-center rounded-2xl text-[13px] font-black text-red-400 transition-all duration-300 hover:bg-red-50 hover:text-red-500 w-full group overflow-hidden h-14 flex-shrink-0"
        [ngClass]="isSidebarCollapsed ? 'md:justify-center px-0' : 'px-5 gap-4'"
      >
        <mat-icon
          class="group-hover:rotate-12 transition-transform flex-shrink-0"
          >logout</mat-icon
        >
        <span
          class="transition-all duration-300 whitespace-nowrap uppercase tracking-widest text-[10px]"
          [ngClass]="
            isSidebarCollapsed
              ? 'md:opacity-0 md:w-0 opacity-100 w-auto'
              : 'opacity-100 w-auto'
          "
          >{{ UILabels.PROFILE.LOGOUT }}</span
        >
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-4 sm:p-8 md:p-12 overflow-auto bg-slate-50/50 relative">
    <div class="max-w-5xl mx-auto">
      <!-- Profile Tab -->
      <div
        *ngIf="activeTab === 'profile'"
        class="space-y-8 sm:space-y-12 animate-fade-in"
      >
        <header
          class="flex flex-col md:flex-row md:items-end justify-between gap-6"
        >
          <div class="space-y-2">
            <h1
              class="text-3xl sm:text-4xl font-black text-slate-800 tracking-tighter"
            >
              {{ UILabels.PROFILE.TITLE }}
            </h1>
            <p
              class="text-slate-400 font-bold uppercase tracking-widest text-[10px] sm:text-xs"
            >
              {{ UILabels.PROFILE.SUBTITLE }}
            </p>
          </div>
          <div
            class="px-5 py-2 bg-primary/5 text-primary rounded-full text-[10px] font-black uppercase tracking-[0.2em] border border-primary/10 shadow-sm shadow-primary/5 w-fit"
          >
            {{ UILabels.PROFILE.VERIFIED_ACCOUNT }}
          </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
          <div class="lg:col-span-8 space-y-8 sm:space-y-10">
            <!-- Personal Info Card -->
            <div
              class="bg-white rounded-[2rem] sm:rounded-[3rem] shadow-[0_20px_60px_rgba(0,0,0,0.03)] border border-slate-100 overflow-hidden group/card hover:shadow-[0_30px_80px_rgba(0,0,0,0.06)] transition-all duration-500"
            >
              <div
                class="p-6 sm:p-8 border-b border-slate-50 bg-slate-50/30 flex items-center justify-between"
              >
                <div class="flex items-center gap-4">
                  <div
                    class="w-10 h-10 rounded-xl bg-white border border-slate-100 flex items-center justify-center text-slate-400 shadow-sm"
                  >
                    <mat-icon class="text-xl">badge</mat-icon>
                  </div>
                  <h2
                    class="font-black text-slate-800 text-sm uppercase tracking-widest"
                  >
                    {{ UILabels.PROFILE.STUDENT_DATA }}
                  </h2>
                </div>
                <div class="w-2 h-2 rounded-full bg-primary/30"></div>
              </div>
              <div class="p-8 sm:p-12 grid grid-cols-1 sm:grid-cols-2 gap-10">
                <div class="space-y-2 group/field">
                  <label
                    class="text-[10px] font-black text-slate-300 uppercase tracking-widest transition-colors group-hover/field:text-primary"
                    >{{ UILabels.PROFILE.NAME }}</label
                  >
                  <p
                    class="text-slate-800 font-black text-xl sm:text-2xl tracking-tight leading-none"
                  >
                    {{ student.name }}
                  </p>
                </div>
                <div class="space-y-2 group/field">
                  <label
                    class="text-[10px] font-black text-slate-300 uppercase tracking-widest transition-colors group-hover/field:text-primary"
                    >{{ UILabels.PROFILE.LAST_NAME }}</label
                  >
                  <p
                    class="text-slate-800 font-black text-xl sm:text-2xl tracking-tight leading-none"
                  >
                    {{ student.last_name }}
                  </p>
                </div>
                <div
                  class="sm:col-span-2 p-6 bg-slate-50/50 rounded-3xl border border-slate-100 group/email transition-all hover:bg-white hover:shadow-lg hover:shadow-slate-200/50"
                >
                  <label
                    class="text-[10px] font-black text-slate-300 uppercase tracking-widest"
                    >{{ UILabels.PROFILE.EMAIL }}</label
                  >
                  <div class="flex items-center gap-4 mt-3">
                    <div
                      class="w-10 h-10 rounded-xl bg-white flex items-center justify-center text-primary shadow-sm border border-slate-100"
                    >
                      <mat-icon class="text-lg">alternate_email</mat-icon>
                    </div>
                    <p
                      class="text-slate-700 font-black text-sm lg:text-base break-all"
                    >
                      {{ student.email }}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Security Card -->
            <div
              class="bg-white rounded-[2rem] sm:rounded-[3rem] shadow-[0_20px_60px_rgba(0,0,0,0.03)] border border-slate-100 overflow-hidden group/card hover:shadow-[0_30px_80px_rgba(0,0,0,0.06)] transition-all duration-500"
            >
              <div
                class="p-6 sm:p-8 border-b border-slate-50 bg-slate-50/30 flex items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-xl bg-white border border-slate-100 flex items-center justify-center text-slate-400 shadow-sm"
                >
                  <mat-icon class="text-xl">fingerprint</mat-icon>
                </div>
                <h2
                  class="font-black text-slate-800 text-sm uppercase tracking-widest"
                >
                  {{ UILabels.PROFILE.ACCESS_CONTROL }}
                </h2>
              </div>
              <div class="p-8 sm:p-10 grid grid-cols-1 sm:grid-cols-2 gap-6">
                <button
                  (click)="forgotPassword()"
                  class="flex items-center justify-between gap-4 p-6 bg-slate-50 rounded-[2rem] border border-slate-100 group/btn transition-all hover:bg-white hover:border-primary hover:shadow-xl hover:shadow-primary/5 text-left"
                >
                  <div class="flex items-center gap-4">
                    <div
                      class="w-12 h-12 rounded-2xl bg-white text-primary flex items-center justify-center shadow-sm border border-slate-100 group-hover/btn:bg-primary group-hover/btn:text-white transition-all"
                    >
                      <mat-icon>lock_open</mat-icon>
                    </div>
                    <div>
                      <h3 class="font-black text-slate-800 text-sm">
                        {{ UILabels.PROFILE.PASSWORD }}
                      </h3>
                      <p
                        class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-1"
                      >
                        {{ UILabels.PROFILE.UPDATE }}
                      </p>
                    </div>
                  </div>
                  <mat-icon
                    class="text-slate-300 group-hover/btn:translate-x-1 transition-transform"
                    >chevron_right</mat-icon
                  >
                </button>

                <!-- 2FA Button -->
                <button
                  (click)="
                    student.two_factor_enabled ? disable2FA() : enable2FA()
                  "
                  class="flex items-center justify-between gap-4 p-6 bg-slate-50 rounded-[2rem] border border-slate-100 group/btn transition-all hover:bg-white hover:border-primary hover:shadow-xl hover:shadow-primary/5 text-left"
                >
                  <div class="flex items-center gap-4">
                    <div
                      class="w-12 h-12 rounded-2xl bg-white text-primary flex items-center justify-center shadow-sm border border-slate-100 group-hover/btn:bg-primary group-hover/btn:text-white transition-all"
                      [ngClass]="{
                        '!bg-primary !text-white': student.two_factor_enabled,
                      }"
                    >
                      <mat-icon>{{
                        student.two_factor_enabled
                          ? "verified_user"
                          : "security"
                      }}</mat-icon>
                    </div>
                    <div>
                      <h3 class="font-black text-slate-800 text-sm">
                        {{ UILabels.PROFILE.TWO_FACTOR_BUTTON_LABEL }}
                      </h3>
                      <p
                        class="text-[10px] font-black uppercase tracking-widest mt-1"
                        [ngClass]="
                          student.two_factor_enabled
                            ? 'text-green-500'
                            : 'text-slate-400'
                        "
                      >
                        {{
                          student.two_factor_enabled
                            ? UILabels.PROFILE.TWO_FACTOR_ENABLED
                            : UILabels.PROFILE.TWO_FACTOR_ENABLE
                        }}
                      </p>
                    </div>
                  </div>
                  <mat-icon
                    class="text-slate-300 group-hover/btn:translate-x-1 transition-transform"
                    >chevron_right</mat-icon
                  >
                </button>

                <button
                  (click)="logout()"
                  class="flex items-center justify-between gap-4 p-6 bg-rose-50/30 rounded-[2rem] border border-rose-100/50 group/btn transition-all hover:bg-white hover:border-rose-300 hover:shadow-xl hover:shadow-rose-900/5 text-left"
                >
                  <div class="flex items-center gap-4">
                    <div
                      class="w-12 h-12 rounded-2xl bg-white text-rose-500 flex items-center justify-center shadow-sm border border-rose-50 group-hover/btn:bg-rose-500 group-hover/btn:text-white transition-all"
                    >
                      <mat-icon>power_settings_new</mat-icon>
                    </div>
                    <div>
                      <h3 class="font-black text-slate-800 text-sm">
                        {{ UILabels.PROFILE.EXIT }}
                      </h3>
                      <p
                        class="text-[10px] text-rose-300 font-black uppercase tracking-widest mt-1"
                      >
                        Logout
                      </p>
                    </div>
                  </div>
                  <mat-icon
                    class="text-rose-200 group-hover/btn:translate-x-1 transition-transform"
                    >chevron_right</mat-icon
                  >
                </button>
              </div>
            </div>
          </div>

          <!-- Account Status Card -->
          <div class="lg:col-span-4 space-y-6 lg:sticky lg:top-12">
            <div
              class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-[2.5rem] p-10 text-white shadow-2xl shadow-slate-900/20 relative overflow-hidden group"
            >
              <div
                class="absolute -right-10 -top-10 w-40 h-40 bg-primary/20 rounded-full blur-3xl group-hover:scale-150 transition-transform duration-1000"
              ></div>
              <div
                class="absolute -left-10 -bottom-10 w-40 h-40 bg-primary/10 rounded-full blur-3xl group-hover:translate-x-10 transition-transform duration-1000"
              ></div>

              <div class="relative z-10 space-y-10">
                <div class="flex flex-col items-center text-center space-y-4">
                  <div
                    class="w-20 h-20 rounded-full bg-white/10 flex items-center justify-center backdrop-blur-md shadow-inner border border-white/10 relative overflow-hidden"
                  >
                    <img
                      *ngIf="student.avatar; else defaultIcon"
                      [src]="student.avatar"
                      referrerpolicy="no-referrer"
                      alt="User Avatar"
                      class="w-full h-full object-cover"
                    />

                    <ng-template #defaultIcon>
                      <mat-icon class="text-4xl text-white/70"
                        >verified</mat-icon
                      >
                    </ng-template>
                  </div>

                  <div>
                    <p class="font-black text-xl tracking-tight">
                      {{ UILabels.PROFILE.ACTIVE }}
                    </p>
                    <p
                      class="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mt-1"
                    >
                      {{ UILabels.PROFILE.STATUS }}
                    </p>
                  </div>
                </div>

                <div
                  class="space-y-4 p-6 bg-white/5 rounded-3xl border border-white/5 backdrop-blur-md"
                >
                  <div
                    class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-400"
                  >
                    <span>{{ UILabels.PROFILE.PROFILE_PROGRESS }}</span>
                    <span class="text-primary"
                      >{{ student.profile_completion }}%</span
                    >
                  </div>
                  <div
                    class="h-2 w-full bg-white/10 rounded-full overflow-hidden"
                  >
                    <div
                      class="h-full bg-primary rounded-full shadow-[0_0_15px_rgba(20,184,166,0.5)] transition-all duration-1000"
                      [style.width.%]="student.profile_completion"
                    ></div>
                  </div>
                </div>

                <div class="pt-4 flex flex-col gap-3">
                  <div class="flex items-center gap-3 text-slate-400">
                    <mat-icon class="text-sm">calendar_today</mat-icon>
                    <span class="text-[11px] font-bold"
                      >{{ UILabels.PROFILE.ENROLLED }}:
                      {{ student.created_at | date: "yyyy/MM/dd" }}</span
                    >
                  </div>
                </div>

                <!-- Balance Section -->
                <div *ngIf="student.user_type_id === 2">
                  <div class="pt-6 border-t border-white/10">
                    <div class="flex items-center justify-between mb-2">
                      <span
                        class="text-[10px] font-black uppercase tracking-widest text-slate-400"
                        >{{ UILabels.PROFILE.CURRENT_BALANCE }}</span
                      >
                      <span class="text-2xl font-black text-white">{{
                        student.balance | currency: "EUR"
                      }}</span>
                    </div>
                    <button
                      (click)="goToTopUp()"
                      class="w-full py-3 bg-primary text-white rounded-xl font-bold uppercase tracking-widest text-[10px] hover:bg-primary-dark transition-colors flex items-center justify-center gap-2"
                    >
                      <mat-icon class="text-sm">add_circle</mat-icon>
                      {{ UILabels.PROFILE.ADD_BALANCE }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Allergies Tab -->
      <div *ngIf="activeTab === 'allergies'" class="space-y-12 animate-fade-in">
        <header class="space-y-2">
          <h1
            class="text-3xl sm:text-4xl font-black text-slate-800 tracking-tighter"
          >
            {{ UILabels.PROFILE.ALLERGIES_TITLE }}
          </h1>
          <p
            class="text-slate-400 font-bold uppercase tracking-widest text-[10px] sm:text-xs"
          >
            {{ UILabels.PROFILE.ALLERGIES_SUBTITLE }}
          </p>
        </header>

        <div
          class="bg-white rounded-[2rem] sm:rounded-[3rem] shadow-[0_20px_60px_rgba(0,0,0,0.03)] border border-slate-100 overflow-hidden"
        >
          <div
            class="p-6 sm:p-8 border-b border-slate-50 bg-slate-50/30 flex items-center gap-4"
          >
            <div
              class="w-10 h-10 rounded-xl bg-white border border-slate-100 flex items-center justify-center text-amber-500 shadow-sm"
            >
              <mat-icon class="text-xl">warning</mat-icon>
            </div>
            <h2
              class="font-black text-slate-800 text-sm uppercase tracking-widest"
            >
              {{ UILabels.PROFILE.DIETARY_CONFIG }}
            </h2>
          </div>

          <form
            [formGroup]="profileForm"
            (ngSubmit)="saveAllergies()"
            class="p-8 sm:p-12 space-y-12"
          >
            <!-- Common Allergies List (Descriptive 2-column layout) -->
            <div class="space-y-10">
              <div class="space-y-4">
                <div class="flex items-center gap-3">
                  <mat-icon class="text-amber-500">warning_amber</mat-icon>
                  <h3 class="text-xl font-black text-slate-800 tracking-tight">
                    {{ UILabels.PROFILE.ALLERGIES_TITLE }}
                  </h3>
                </div>
                <p
                  class="text-sm font-medium text-slate-500 leading-relaxed max-w-2xl"
                >
                  {{ UILabels.PROFILE.ALLERGIES_SUBTITLE }}
                </p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-10">
                <div
                  *ngFor="let allergy of allergies"
                  (click)="toggleAllergy(allergy.id)"
                  class="flex items-start gap-5 group cursor-pointer"
                >
                  <div class="relative mt-1">
                    <div
                      class="w-7 h-7 rounded-lg border-2 transition-all duration-300 flex items-center justify-center active:scale-95"
                      [ngClass]="
                        isAllergySelected(allergy.id)
                          ? 'bg-primary border-primary shadow-lg shadow-primary/20'
                          : 'bg-white border-slate-200 group-hover:border-slate-300'
                      "
                    ></div>
                  </div>
                  <div class="space-y-1 overflow-hidden">
                    <h4
                      class="font-black text-slate-800 leading-none transition-colors group-hover:text-primary"
                    >
                      {{ allergy.name }}
                    </h4>
                    <p
                      class="text-xs font-medium text-slate-400 leading-snug group-hover:text-slate-500 transition-colors"
                    >
                      {{
                        allergy.description || "Sense descripci√≥ disponible."
                      }}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Custom Allergies -->
            <div class="space-y-6">
              <div
                class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
              >
                <p
                  class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center sm:text-left"
                >
                  {{ UILabels.PROFILE.OTHER_OBSERVATIONS }}
                </p>
                <div
                  class="flex items-center gap-2 justify-center sm:justify-end text-slate-300"
                >
                  <mat-icon class="text-xs">info</mat-icon>
                  <span class="text-[9px] font-bold italic">{{
                    UILabels.PROFILE.COMMA_SEPARATED
                  }}</span>
                </div>
              </div>
              <div class="relative group/textarea">
                <textarea
                  formControlName="custom_allergies"
                  [placeholder]="UILabels.PROFILE.CUSTOM_ALLERGIES_PLACEHOLDER"
                  class="w-full rounded-2xl sm:rounded-[2rem] border-2 border-slate-50 px-6 sm:px-8 py-6 sm:py-8 text-sm sm:text-base focus:ring-[10px] focus:ring-primary/5 focus:border-primary outline-none transition-all min-h-[160px] bg-slate-50/30 font-black text-slate-800 placeholder:text-slate-200 placeholder:font-black placeholder:uppercase placeholder:tracking-widest"
                ></textarea>
                <div
                  class="absolute bottom-6 right-8 opacity-0 group-focus-within/textarea:opacity-100 transition-opacity"
                >
                  <mat-icon class="text-primary animate-bounce">edit</mat-icon>
                </div>
              </div>
            </div>

            <!-- Footer / Submit -->
            <div
              class="pt-6 flex flex-col sm:flex-row-reverse items-center justify-between gap-8 border-t border-slate-50"
            >
              <button
                type="submit"
                class="w-full sm:w-auto px-12 py-5 bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-2xl sm:rounded-[2rem] font-black uppercase tracking-[0.2em] text-xs hover:from-primary hover:to-primary-dark transition-all duration-500 shadow-2xl shadow-slate-900/20 active:scale-95 flex items-center justify-center gap-4 group"
              >
                <span>{{ UILabels.PROFILE.SAVE_CHANGES }}</span>
                <mat-icon
                  class="group-hover:translate-x-2 transition-transform duration-500"
                  >verified</mat-icon
                >
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Config Tab (Admin only) -->
      <div
        *ngIf="activeTab === 'config' && student.user_type_id == 1"
        class="animate-fade-in"
      >
        <app-admin-configuration></app-admin-configuration>
      </div>

      <!-- Transactions Tab -->
      <div
        *ngIf="activeTab === 'transactions' && student.user_type_id === 2"
        class="animate-fade-in"
      >
        <app-transaction-history></app-transaction-history>
      </div>
    </div>
  </main>

  <!-- 2FA Setup Modal Component -->
  <app-two-factor-setup-modal
    [show]="show2FASecret"
    [secret]="twoFASecret"
    [qrCode]="twoFAQRCode"
    (close)="show2FASecret = false"
    (setupComplete)="on2FASetupComplete()"
  ></app-two-factor-setup-modal>
</div>
